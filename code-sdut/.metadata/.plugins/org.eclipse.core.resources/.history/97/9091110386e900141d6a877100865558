package cn.sudt.deploy;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import cn.sudt.config.ToolConfig;
import cn.sudt.deploy.scheme.DeployScheme;
import cn.sudt.deploy.scheme.HostInfo;
import cn.sudt.lang.io.Log4jConfig;
import cn.sudt.ui.common.UiConst;
import cn.sudt.ui.tab.DeployTabbed;

/**
 * 部署管理器(部署过程为阻塞过程，加入到线程中)
 * 
 * @author chongming
 *
 */
public class DeployManager extends Thread {
	/**
	 * 通过共享变量控制线程并发
	 * 
	 * 暂停部署过程
	 */
	private volatile boolean pause = false;
	/**
	 * 中断部署过程
	 */
	private volatile boolean interrupt = true;
	
	private ConcurrentController concurrentController = null;
	
	private DeployTabbed deployTab = null;
	
	public DeployManager(DeployTabbed deployTab, ConcurrentController concurrentController) {
		super();
		this.concurrentController = concurrentController;
		this.deployTab = deployTab;
	}
	
	@Override
	public void run() {
		executeDeploy();
	}
	
	/**
	 * 创建部署线程，执行部署
	 */
	private void executeDeploy() {
		DeployScheme deployScheme = getDeployScheme();
		String configPath = ToolConfig.USER_DIR + "/cfg/log4j.properties";
		List<String> logName = new ArrayList<String>();
		
		for (int i = 0; i < deployScheme.getHostList().size(); i++) {
			HostInfo hostInfo = deployScheme.getHostList().get(i);
			logName.add(hostInfo.getIp() + "_" + hostInfo.getPort() + ".log");
		}
		
		Log4jConfig.initLogConfig(configPath, true, 
				ToolConfig.LOG_DIR, logName.toArray(new String[0]));
		
		try {
			for (int i = 0; i < deployScheme.getHostList().size(); i++) {
				HostInfo hostInfo = deployScheme.getHostList().get(i);
				Log log = LogFactory.getLog("logFile" + i);
				DeployThread deployThread = new DeployThread(hostInfo,
						deployScheme.getCommandList(), log);
				concurrentController.getPool().offer(deployThread);
			}
			
			/**
			 * 部署线程并发执行
			 */
			concurrentController.execute();
			
			if (interrupt) {
				deployTab.getBottomPanel().setBusyLabelText(ToolConfig.i18.getProperty(
						"soft.deploy.tool.deploy.interrupt"));
				deployTab.getCmdTablePanel().getCmdExeBtn().setEnabled(true);
			} else {
				deployTab.getBottomPanel().setBusyLabelText(ToolConfig.i18.getProperty(
						"soft.deploy.tool.deploy.end"));
			}
			deployTab.setBtnStatus(true);
			Thread.sleep(UiConst.MES_WAIT_TIME);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	private DeployScheme getDeployScheme() {
		DeployScheme deployScheme = new DeployScheme();
		deployScheme.setHostList(deployTab.getHostTablePanel().getHosts());
		deployScheme.setCommandList(deployTab.getCmdTablePanel().getCommands());
		return deployScheme;
	}

	public void setPause(boolean pause) {
		this.pause = pause;
		if (pause) {
			deployTab.getBottomPanel().setBusyLabelText(
				ToolConfig.i18.getProperty("soft.deploy.tool.deploy.pause"));
		} else {
			concurrentController.setBottomPanelText();
		}
	}
	
	/**
	 * 窗口提示正在部署的ip:port
	 * 
	 */
	public void setIaskInfo() {
		String text = "";
		for (Thread thread : concurrentController.getDeployThread()) {
			text += thread.getName() + "/";
		}
		
		if (text.length() > 1) {
			text = text.substring(0, text.length() - 1);
			bottomlPanel.setBusyLabelText(text);
		}
	}

	public boolean isPause() {
		return pause;
	}

	public boolean isInterrupt() {
		return interrupt;
	}

	public void setInterrupt(boolean interrupt) {
		this.interrupt = interrupt;
	}

	public DeployTabbed getDeployTab() {
		return deployTab;
	}
	
}
